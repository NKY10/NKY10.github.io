<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RAG八股文 | openset的博客</title><meta name=keywords content="RAG,八股文"><meta name=description content="摘要：RAG知识整理"><meta name=author content><link rel=canonical href=https://nky10.github.io/theory/llm/rag/><link crossorigin=anonymous href=../../../assets/css/stylesheet.08f7d74f0ada0f975d29ae436285b61ed7a719d05f350cb888d00341642995a2.css integrity="sha256-CPfXTwraD5ddKa5DYoW2HtenGdBfNQy4iNADQWQplaI=" rel="preload stylesheet" as=style><link rel=icon href=https://nky10.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nky10.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://nky10.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://nky10.github.io/apple-touch-icon.png><link rel=mask-icon href=https://nky10.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://nky10.github.io/theory/llm/rag/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams",processRefs:!1},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><style>.MathJax{outline:0}.MathJax:focus{outline:none}.MathJax_Display{margin:1em 0}.MathJax span{font-size:inherit}</style><meta property="og:url" content="https://nky10.github.io/theory/llm/rag/"><meta property="og:site_name" content="openset的博客"><meta property="og:title" content="RAG八股文"><meta property="og:description" content="摘要：RAG知识整理"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="theory"><meta property="article:published_time" content="2025-09-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-09-02T00:00:00+00:00"><meta property="article:tag" content="RAG"><meta property="article:tag" content="八股文"><meta name=twitter:card content="summary"><meta name=twitter:title content="RAG八股文"><meta name=twitter:description content="摘要：RAG知识整理"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"笔记记录","item":"https://nky10.github.io/theory/"},{"@type":"ListItem","position":2,"name":"大语言模型","item":"https://nky10.github.io/theory/llm/"},{"@type":"ListItem","position":3,"name":"RAG八股文","item":"https://nky10.github.io/theory/llm/rag/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RAG八股文","name":"RAG八股文","description":"摘要：RAG知识整理","keywords":["RAG","八股文"],"articleBody":"1. RAG 基本概念 RAG 是 Retrieval-Augmented Generation 的缩写，即检索增强生成。 基本的RAG有三个阶段：\ngraph TD A[用户输入] --\u003e B[检索] B --\u003e C[生成] 本质是利用了大语言模型（LLM）的上下文学习（In Context Learning， ICL）能力，通过将检索到的相关文档作为上下文输入，模型能够生成与上下文相关的文本。这对模型的上下文窗口有要求，理论上来说，只要模型的上下文窗口足够大，模型就一定能生成正确的回复。但是LLM的上下文窗口是有限的，且因为幻觉的存在（模型生成的文本可能与上下文不一致），所以检索到精确、高质量文档片段很重要。\n2. RAG 分类方法 2.1 按架构分类 2.1.1 Naive RAG（基础RAG） 流程：索引 → 检索 → 生成 特点：直接检索相关文档片段，拼接后输入LLM 优点：实现简单，易于部署 缺点：检索质量依赖文档分块策略，容易产生幻觉 2.1.2 Advanced RAG（高级RAG） 流程：预处理 → 索引 → 检索 → 后处理 → 生成 特点：在检索前后增加预处理和后处理步骤 预处理：文档清洗、结构化、元数据增强 后处理：重排序、去重、相关性过滤 2.1.3 Modular RAG（模块化RAG） 特点：将RAG系统分解为可插拔的模块 模块包括：搜索模块、记忆模块、路由模块等 优点：灵活性强，可根据需求定制 2.2 按应用场景分类 2.2.1 问答系统 基于知识库的问答 多轮对话系统 事实核查系统 2.2.2 文档分析 长文档摘要 文档对比分析 信息提取 2.2.3 代码生成 代码补全 API文档查询 代码解释 3. RAG 优化技术详解 3.1 索引环节优化 3.1.1 文档预处理优化 文档清洗：去除无关内容（页眉页脚、广告等） 格式标准化：统一文档格式（PDF、HTML、Markdown等） 语言识别：多语言文档处理 3.1.2 分块策略优化（详细实现） 固定大小分块\n1# LlamaIndex 实现 2from llama_index.core.node_parser import SentenceSplitter 3splitter = SentenceSplitter(chunk_size=512, chunk_overlap=50) 4nodes = splitter.get_nodes_from_documents(documents) 语义分块\n1# 基于语义相似度的分块 2from llama_index.core.node_parser import SemanticSplitterNodeParser 3from llama_index.embeddings.openai import OpenAIEmbedding 4 5embed_model = OpenAIEmbedding() 6splitter = SemanticSplitterNodeParser( 7 buffer_size=1, 8 breakpoint_percentile_threshold=95, 9 embed_model=embed_model 10) 11nodes = splitter.get_nodes_from_documents(documents) 层次化分块\n1# 多粒度分块策略 2from llama_index.core.node_parser import HierarchicalNodeParser 3 4splitter = HierarchicalNodeParser( 5 chunk_sizes=[512, 256, 128], # 不同粒度的分块大小 6 chunk_overlap=20 7) 8nodes = splitter.get_nodes_from_documents(documents) 3.1.3 向量化优化 嵌入模型选择\n通用模型：OpenAI text-embedding-ada-002（1536维） 开源模型：BAAI/bge-large-en-v1.5（1024维）、E5系列 领域专用：BioBERT（医疗）、CodeBERT（代码） 微调嵌入模型\n1# 领域适配微调 2from llama_index.finetuning import SentenceTransformersFinetuneEngine 3 4finetune_engine = SentenceTransformersFinetuneEngine( 5 train_dataset, 6 model_id=\"BAAI/bge-small-en\", 7 model_output_path=\"fine_tuned_model\" 8) 9finetune_engine.finetune() 10embed_model = finetune_engine.get_finetuned_model() 3.1.4 索引结构优化 向量数据库选择\n内存型：FAISS（Facebook）、Annoy（Spotify） 持久化：Pinecone、Weaviate、Chroma、Milvus 本地部署：Qdrant、Vespa 多级索引策略\n1# 摘要索引 + 详细索引的双层策略 2from llama_index.core import SummaryIndex, VectorStoreIndex 3 4# 创建摘要索引（用于快速过滤） 5summary_index = SummaryIndex.from_documents(documents) 6# 创建详细索引（用于精确检索） 7detailed_index = VectorStoreIndex.from_documents(documents) 3.2 检索环节优化 3.2.1 查询重写（详细实现） 查询扩展（RAG-Fusion）\n1# 多查询生成和融合检索 2from llama_index.core.retrievers import MultiQueryRetriever 3 4# 生成多个相关查询 5retriever = MultiQueryRetriever.from_defaults( 6 retriever=base_retriever, 7 llm=llm, 8 num_queries=3 # 生成3个相关查询 9) 10 11# 使用倒数排序融合（RRF） 12from llama_index.postprocessor import ReciprocalRerankFusion 13 14reranker = ReciprocalRerankFusion( 15 top_k=10, 16 fusion_weight=0.5 17) Step-Back Prompting\n1# 后退一步提问策略 2step_back_prompt = \"\"\" 3请后退一步，思考这个问题的更广泛背景：{query} 4基于这个背景，重新表述问题。 5\"\"\" 6 7# 使用LLM生成更抽象的问题 8abstract_query = llm.generate(step_back_prompt.format(query=user_query)) 3.2.2 多模态检索 混合检索实现\n1# 向量检索 + 关键词检索 2from llama_index.core.retrievers import VectorIndexRetriever, KeywordTableRetriever 3from llama_index.core.retrievers import EnsembleRetriever 4 5vector_retriever = VectorIndexRetriever(index=vector_index, similarity_top_k=5) 6keyword_retriever = KeywordTableRetriever(index=keyword_index, similarity_top_k=5) 7 8ensemble_retriever = EnsembleRetriever( 9 retrievers=[vector_retriever, keyword_retriever], 10 weights=[0.7, 0.3] # 权重分配 11) 元数据过滤\n1# 基于时间、作者等元数据过滤 2from llama_index.core.retrievers import VectorIndexRetriever 3 4retriever = VectorIndexRetriever( 5 index=vector_index, 6 similarity_top_k=10, 7 filters=[ 8 {\"date\": {\"\u003e=\": \"2024-01-01\"}}, # 2024年之后的文档 9 {\"author\": \"John Doe\"} # 特定作者的文档 10 ] 11) 3.2.3 重排序技术 交叉编码器重排序\n1# 使用Cohere等服务的重排序 2from llama_index.postprocessor.cohere_rerank import CohereRerank 3 4cohere_rerank = CohereRerank( 5 api_key=cohere_api_key, 6 top_n=3 # 返回最相关的3个结果 7) 8 9query_engine = index.as_query_engine( 10 similarity_top_k=10, # 先检索10个 11 node_postprocessors=[cohere_rerank] # 然后重排序 12) LongContextReorder\n1# 解决\"中间信息丢失\"问题 2from llama_index.postprocessor import LongContextReorder 3 4reorder = LongContextReorder() 5query_engine = index.as_query_engine( 6 similarity_top_k=5, 7 node_postprocessors=[reorder] 8) 3.2.4 检索策略优化 多跳检索实现\n1# 迭代式检索策略 2from llama_index.core.query_engine import MultiStepQueryEngine 3 4query_engine = MultiStepQueryEngine.from_defaults( 5 query_engine_tools=[tool1, tool2], 6 max_iterations=3 # 最多3次迭代 7) 动态检索（DRAGIN）\n1# 基于信息需求的动态检索 2from llama_index.core.retrievers import DynamicRetriever 3 4dynamic_retriever = DynamicRetriever( 5 base_retriever=vector_retriever, 6 llm=llm, 7 retrieval_threshold=0.7 # 检索阈值 8) 3.3 生成环节优化 3.3.1 提示压缩技术 LongLLMLingua提示压缩\n1# 压缩过长的上下文 2from llama_index.postprocessor import LongLLMLinguaPostprocessor 3 4node_postprocessor = LongLLMLinguaPostprocessor( 5 instruction_str=\"基于上下文回答问题\", 6 target_token=300, # 目标token数 7 rank_method=\"longllmlingua\", 8 additional_compress_kwargs={ 9 \"condition_compare\": True, 10 \"context_budget\": \"+100\", 11 \"reorder_context\": \"sort\" 12 } 13) 14 15# 应用压缩 16compressed_nodes = node_postprocessor.postprocess_nodes( 17 retrieved_nodes, 18 query_bundle=QueryBundle(query_str=query) 19) 3.3.2 结构化输出 Pydantic程序\n1# 结构化输出解析 2from llama_index.output_parsers import LangchainOutputParser 3from llama_index.llms import OpenAI 4from langchain.output_parsers import StructuredOutputParser, ResponseSchema 5 6# 定义输出模式 7response_schemas = [ 8 ResponseSchema(name=\"answer\", description=\"问题的答案\"), 9 ResponseSchema(name=\"confidence\", description=\"答案的置信度\"), 10 ResponseSchema(name=\"sources\", description=\"引用来源\") 11] 12 13lc_output_parser = StructuredOutputParser.from_response_schemas(response_schemas) 14output_parser = LangchainOutputParser(lc_output_parser) 15 16# 将解析器附加到LLM 17llm = OpenAI(output_parser=output_parser) 3.3.3 事实性增强 引用生成和验证\n1# 自动生成引用 2from llama_index.core.response_synthesizers import Refine 3 4synthesizer = Refine( 5 llm=llm, 6 response_mode=\"refine\", 7 include_ref=True # 包含引用 8) 9 10# 置信度评估 11confidence_prompt = \"\"\" 12请评估以下回答的置信度（0-100分）： 13问题：{question} 14回答：{answer} 15上下文：{context} 16\"\"\" 3.4 生成环节优化 3.4.1 生成控制 温度调节：控制生成结果的随机性 Top-p采样：控制生成词汇的多样性 重复惩罚：避免重复内容生成 3.4.2 事实性增强 引用生成：为生成内容添加引用来源 置信度评估：评估生成内容的可信度 事实核查：对生成内容进行事实验证 3.4.3 风格控制 风格迁移：控制生成内容的风格 长度控制：控制生成内容的长度 格式控制：控制生成内容的格式 4. 综合优化策略 4.1 端到端优化 联合训练：同时优化检索器和生成器 强化学习：基于用户反馈优化系统 多任务学习：同时优化多个相关任务 4.2 评估指标 检索质量：Recall@k、NDCG、MRR 生成质量：BLEU、ROUGE、BERTScore 用户体验：响应时间、准确性、满意度 4.3 性能优化 缓存策略：缓存频繁查询的结果 异步处理：并行处理多个请求 负载均衡：分布式部署提高并发能力 5. 未来发展趋势 5.1 技术趋势 多模态RAG：结合文本、图像、音频等多模态信息 自适应RAG：根据用户反馈自适应调整策略 可解释RAG：提高系统的透明度和可解释性 5.2 应用趋势 企业级应用：面向企业的定制化RAG解决方案 移动端应用：轻量级RAG在移动设备上的应用 边缘计算：在边缘设备上部署RAG系统 ","wordCount":"604","inLanguage":"en","datePublished":"2025-09-02T00:00:00Z","dateModified":"2025-09-02T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://nky10.github.io/theory/llm/rag/"},"publisher":{"@type":"Organization","name":"openset的博客","logo":{"@type":"ImageObject","url":"https://nky10.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nky10.github.io/ accesskey=h title="openset的博客 (Alt + H)">openset的博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://nky10.github.io/ title=主页><span>主页</span></a></li><li><a href=https://nky10.github.io/theory/ title=理论学习><span>理论学习</span></a></li><li><a href=https://nky10.github.io/explore/ title=实践总结><span>实践总结</span></a></li><li><a href=https://nky10.github.io/anything/ title=随笔><span>随笔</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">RAG八股文</h1><div class=post-meta><span title='2025-09-02 00:00:00 +0000 UTC'>September 2, 2025</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-rag-%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 aria-label="1. RAG 基本概念">1. RAG 基本概念</a></li><li><a href=#2-rag-%e5%88%86%e7%b1%bb%e6%96%b9%e6%b3%95 aria-label="2. RAG 分类方法">2. RAG 分类方法</a><ul><li><a href=#21-%e6%8c%89%e6%9e%b6%e6%9e%84%e5%88%86%e7%b1%bb aria-label="2.1 按架构分类">2.1 按架构分类</a><ul><li><a href=#211-naive-rag%e5%9f%ba%e7%a1%80rag aria-label="2.1.1 Naive RAG（基础RAG）">2.1.1 Naive RAG（基础RAG）</a></li><li><a href=#212-advanced-rag%e9%ab%98%e7%ba%a7rag aria-label="2.1.2 Advanced RAG（高级RAG）">2.1.2 Advanced RAG（高级RAG）</a></li><li><a href=#213-modular-rag%e6%a8%a1%e5%9d%97%e5%8c%96rag aria-label="2.1.3 Modular RAG（模块化RAG）">2.1.3 Modular RAG（模块化RAG）</a></li></ul></li><li><a href=#22-%e6%8c%89%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af%e5%88%86%e7%b1%bb aria-label="2.2 按应用场景分类">2.2 按应用场景分类</a><ul><li><a href=#221-%e9%97%ae%e7%ad%94%e7%b3%bb%e7%bb%9f aria-label="2.2.1 问答系统">2.2.1 问答系统</a></li><li><a href=#222-%e6%96%87%e6%a1%a3%e5%88%86%e6%9e%90 aria-label="2.2.2 文档分析">2.2.2 文档分析</a></li><li><a href=#223-%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90 aria-label="2.2.3 代码生成">2.2.3 代码生成</a></li></ul></li></ul></li><li><a href=#3-rag-%e4%bc%98%e5%8c%96%e6%8a%80%e6%9c%af%e8%af%a6%e8%a7%a3 aria-label="3. RAG 优化技术详解">3. RAG 优化技术详解</a><ul><li><a href=#31-%e7%b4%a2%e5%bc%95%e7%8e%af%e8%8a%82%e4%bc%98%e5%8c%96 aria-label="3.1 索引环节优化">3.1 索引环节优化</a><ul><li><a href=#311-%e6%96%87%e6%a1%a3%e9%a2%84%e5%a4%84%e7%90%86%e4%bc%98%e5%8c%96 aria-label="3.1.1 文档预处理优化">3.1.1 文档预处理优化</a></li><li><a href=#312-%e5%88%86%e5%9d%97%e7%ad%96%e7%95%a5%e4%bc%98%e5%8c%96%e8%af%a6%e7%bb%86%e5%ae%9e%e7%8e%b0 aria-label="3.1.2 分块策略优化（详细实现）">3.1.2 分块策略优化（详细实现）</a></li><li><a href=#313-%e5%90%91%e9%87%8f%e5%8c%96%e4%bc%98%e5%8c%96 aria-label="3.1.3 向量化优化">3.1.3 向量化优化</a></li><li><a href=#314-%e7%b4%a2%e5%bc%95%e7%bb%93%e6%9e%84%e4%bc%98%e5%8c%96 aria-label="3.1.4 索引结构优化">3.1.4 索引结构优化</a></li></ul></li><li><a href=#32-%e6%a3%80%e7%b4%a2%e7%8e%af%e8%8a%82%e4%bc%98%e5%8c%96 aria-label="3.2 检索环节优化">3.2 检索环节优化</a><ul><li><a href=#321-%e6%9f%a5%e8%af%a2%e9%87%8d%e5%86%99%e8%af%a6%e7%bb%86%e5%ae%9e%e7%8e%b0 aria-label="3.2.1 查询重写（详细实现）">3.2.1 查询重写（详细实现）</a></li><li><a href=#322-%e5%a4%9a%e6%a8%a1%e6%80%81%e6%a3%80%e7%b4%a2 aria-label="3.2.2 多模态检索">3.2.2 多模态检索</a></li><li><a href=#323-%e9%87%8d%e6%8e%92%e5%ba%8f%e6%8a%80%e6%9c%af aria-label="3.2.3 重排序技术">3.2.3 重排序技术</a></li><li><a href=#324-%e6%a3%80%e7%b4%a2%e7%ad%96%e7%95%a5%e4%bc%98%e5%8c%96 aria-label="3.2.4 检索策略优化">3.2.4 检索策略优化</a></li></ul></li><li><a href=#33-%e7%94%9f%e6%88%90%e7%8e%af%e8%8a%82%e4%bc%98%e5%8c%96 aria-label="3.3 生成环节优化">3.3 生成环节优化</a><ul><li><a href=#331-%e6%8f%90%e7%a4%ba%e5%8e%8b%e7%bc%a9%e6%8a%80%e6%9c%af aria-label="3.3.1 提示压缩技术">3.3.1 提示压缩技术</a></li><li><a href=#332-%e7%bb%93%e6%9e%84%e5%8c%96%e8%be%93%e5%87%ba aria-label="3.3.2 结构化输出">3.3.2 结构化输出</a></li><li><a href=#333-%e4%ba%8b%e5%ae%9e%e6%80%a7%e5%a2%9e%e5%bc%ba aria-label="3.3.3 事实性增强">3.3.3 事实性增强</a></li></ul></li><li><a href=#34-%e7%94%9f%e6%88%90%e7%8e%af%e8%8a%82%e4%bc%98%e5%8c%96 aria-label="3.4 生成环节优化">3.4 生成环节优化</a><ul><li><a href=#341-%e7%94%9f%e6%88%90%e6%8e%a7%e5%88%b6 aria-label="3.4.1 生成控制">3.4.1 生成控制</a></li><li><a href=#342-%e4%ba%8b%e5%ae%9e%e6%80%a7%e5%a2%9e%e5%bc%ba aria-label="3.4.2 事实性增强">3.4.2 事实性增强</a></li><li><a href=#343-%e9%a3%8e%e6%a0%bc%e6%8e%a7%e5%88%b6 aria-label="3.4.3 风格控制">3.4.3 风格控制</a></li></ul></li></ul></li><li><a href=#4-%e7%bb%bc%e5%90%88%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a5 aria-label="4. 综合优化策略">4. 综合优化策略</a><ul><li><a href=#41-%e7%ab%af%e5%88%b0%e7%ab%af%e4%bc%98%e5%8c%96 aria-label="4.1 端到端优化">4.1 端到端优化</a></li><li><a href=#42-%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87 aria-label="4.2 评估指标">4.2 评估指标</a></li><li><a href=#43-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96 aria-label="4.3 性能优化">4.3 性能优化</a></li></ul></li><li><a href=#5-%e6%9c%aa%e6%9d%a5%e5%8f%91%e5%b1%95%e8%b6%8b%e5%8a%bf aria-label="5. 未来发展趋势">5. 未来发展趋势</a><ul><li><a href=#51-%e6%8a%80%e6%9c%af%e8%b6%8b%e5%8a%bf aria-label="5.1 技术趋势">5.1 技术趋势</a></li><li><a href=#52-%e5%ba%94%e7%94%a8%e8%b6%8b%e5%8a%bf aria-label="5.2 应用趋势">5.2 应用趋势</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=1-rag-基本概念>1. RAG 基本概念<a hidden class=anchor aria-hidden=true href=#1-rag-基本概念>#</a></h2><p>RAG 是 Retrieval-Augmented Generation 的缩写，即检索增强生成。
基本的RAG有三个阶段：</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TD
    A[用户输入] --&gt; B[检索]
    B --&gt; C[生成]
</code></pre><p>本质是利用了大语言模型（LLM）的上下文学习（In Context Learning， ICL）能力，通过将检索到的相关文档作为上下文输入，模型能够生成与上下文相关的文本。这对模型的上下文窗口有要求，理论上来说，只要模型的上下文窗口足够大，模型就一定能生成正确的回复。但是LLM的上下文窗口是有限的，且因为幻觉的存在（模型生成的文本可能与上下文不一致），所以检索到精确、高质量文档片段很重要。</p><h2 id=2-rag-分类方法>2. RAG 分类方法<a hidden class=anchor aria-hidden=true href=#2-rag-分类方法>#</a></h2><h3 id=21-按架构分类>2.1 按架构分类<a hidden class=anchor aria-hidden=true href=#21-按架构分类>#</a></h3><h4 id=211-naive-rag基础rag>2.1.1 Naive RAG（基础RAG）<a hidden class=anchor aria-hidden=true href=#211-naive-rag基础rag>#</a></h4><ul><li><strong>流程</strong>：索引 → 检索 → 生成</li><li><strong>特点</strong>：直接检索相关文档片段，拼接后输入LLM</li><li><strong>优点</strong>：实现简单，易于部署</li><li><strong>缺点</strong>：检索质量依赖文档分块策略，容易产生幻觉</li></ul><h4 id=212-advanced-rag高级rag>2.1.2 Advanced RAG（高级RAG）<a hidden class=anchor aria-hidden=true href=#212-advanced-rag高级rag>#</a></h4><ul><li><strong>流程</strong>：预处理 → 索引 → 检索 → 后处理 → 生成</li><li><strong>特点</strong>：在检索前后增加预处理和后处理步骤</li><li><strong>预处理</strong>：文档清洗、结构化、元数据增强</li><li><strong>后处理</strong>：重排序、去重、相关性过滤</li></ul><h4 id=213-modular-rag模块化rag>2.1.3 Modular RAG（模块化RAG）<a hidden class=anchor aria-hidden=true href=#213-modular-rag模块化rag>#</a></h4><ul><li><strong>特点</strong>：将RAG系统分解为可插拔的模块</li><li><strong>模块包括</strong>：搜索模块、记忆模块、路由模块等</li><li><strong>优点</strong>：灵活性强，可根据需求定制</li></ul><h3 id=22-按应用场景分类>2.2 按应用场景分类<a hidden class=anchor aria-hidden=true href=#22-按应用场景分类>#</a></h3><h4 id=221-问答系统>2.2.1 问答系统<a hidden class=anchor aria-hidden=true href=#221-问答系统>#</a></h4><ul><li>基于知识库的问答</li><li>多轮对话系统</li><li>事实核查系统</li></ul><h4 id=222-文档分析>2.2.2 文档分析<a hidden class=anchor aria-hidden=true href=#222-文档分析>#</a></h4><ul><li>长文档摘要</li><li>文档对比分析</li><li>信息提取</li></ul><h4 id=223-代码生成>2.2.3 代码生成<a hidden class=anchor aria-hidden=true href=#223-代码生成>#</a></h4><ul><li>代码补全</li><li>API文档查询</li><li>代码解释</li></ul><h2 id=3-rag-优化技术详解>3. RAG 优化技术详解<a hidden class=anchor aria-hidden=true href=#3-rag-优化技术详解>#</a></h2><h3 id=31-索引环节优化>3.1 索引环节优化<a hidden class=anchor aria-hidden=true href=#31-索引环节优化>#</a></h3><h4 id=311-文档预处理优化>3.1.1 文档预处理优化<a hidden class=anchor aria-hidden=true href=#311-文档预处理优化>#</a></h4><ul><li><strong>文档清洗</strong>：去除无关内容（页眉页脚、广告等）</li><li><strong>格式标准化</strong>：统一文档格式（PDF、HTML、Markdown等）</li><li><strong>语言识别</strong>：多语言文档处理</li></ul><h4 id=312-分块策略优化详细实现>3.1.2 分块策略优化（详细实现）<a hidden class=anchor aria-hidden=true href=#312-分块策略优化详细实现>#</a></h4><p><strong>固定大小分块</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># LlamaIndex 实现</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.node_parser</span> <span style=color:#cf222e>import</span> SentenceSplitter
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>splitter <span style=color:#0550ae>=</span> SentenceSplitter<span style=color:#1f2328>(</span>chunk_size<span style=color:#0550ae>=</span><span style=color:#0550ae>512</span><span style=color:#1f2328>,</span> chunk_overlap<span style=color:#0550ae>=</span><span style=color:#0550ae>50</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>nodes <span style=color:#0550ae>=</span> splitter<span style=color:#0550ae>.</span>get_nodes_from_documents<span style=color:#1f2328>(</span>documents<span style=color:#1f2328>)</span>
</span></span></code></pre></div><p><strong>语义分块</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 基于语义相似度的分块</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.node_parser</span> <span style=color:#cf222e>import</span> SemanticSplitterNodeParser
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.embeddings.openai</span> <span style=color:#cf222e>import</span> OpenAIEmbedding
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>embed_model <span style=color:#0550ae>=</span> OpenAIEmbedding<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>splitter <span style=color:#0550ae>=</span> SemanticSplitterNodeParser<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    buffer_size<span style=color:#0550ae>=</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    breakpoint_percentile_threshold<span style=color:#0550ae>=</span><span style=color:#0550ae>95</span><span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    embed_model<span style=color:#0550ae>=</span>embed_model
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>nodes <span style=color:#0550ae>=</span> splitter<span style=color:#0550ae>.</span>get_nodes_from_documents<span style=color:#1f2328>(</span>documents<span style=color:#1f2328>)</span>
</span></span></code></pre></div><p><strong>层次化分块</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># 多粒度分块策略</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.node_parser</span> <span style=color:#cf222e>import</span> HierarchicalNodeParser
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>splitter <span style=color:#0550ae>=</span> HierarchicalNodeParser<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    chunk_sizes<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span><span style=color:#0550ae>512</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>256</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>128</span><span style=color:#1f2328>],</span>  <span style=color:#57606a># 不同粒度的分块大小</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    chunk_overlap<span style=color:#0550ae>=</span><span style=color:#0550ae>20</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>nodes <span style=color:#0550ae>=</span> splitter<span style=color:#0550ae>.</span>get_nodes_from_documents<span style=color:#1f2328>(</span>documents<span style=color:#1f2328>)</span>
</span></span></code></pre></div><h4 id=313-向量化优化>3.1.3 向量化优化<a hidden class=anchor aria-hidden=true href=#313-向量化优化>#</a></h4><p><strong>嵌入模型选择</strong></p><ul><li><strong>通用模型</strong>：OpenAI text-embedding-ada-002（1536维）</li><li><strong>开源模型</strong>：BAAI/bge-large-en-v1.5（1024维）、E5系列</li><li><strong>领域专用</strong>：BioBERT（医疗）、CodeBERT（代码）</li></ul><p><strong>微调嵌入模型</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 领域适配微调</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.finetuning</span> <span style=color:#cf222e>import</span> SentenceTransformersFinetuneEngine
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>finetune_engine <span style=color:#0550ae>=</span> SentenceTransformersFinetuneEngine<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    train_dataset<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    model_id<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;BAAI/bge-small-en&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    model_output_path<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;fine_tuned_model&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>finetune_engine<span style=color:#0550ae>.</span>finetune<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>embed_model <span style=color:#0550ae>=</span> finetune_engine<span style=color:#0550ae>.</span>get_finetuned_model<span style=color:#1f2328>()</span>
</span></span></code></pre></div><h4 id=314-索引结构优化>3.1.4 索引结构优化<a hidden class=anchor aria-hidden=true href=#314-索引结构优化>#</a></h4><p><strong>向量数据库选择</strong></p><ul><li><strong>内存型</strong>：FAISS（Facebook）、Annoy（Spotify）</li><li><strong>持久化</strong>：Pinecone、Weaviate、Chroma、Milvus</li><li><strong>本地部署</strong>：Qdrant、Vespa</li></ul><p><strong>多级索引策略</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># 摘要索引 + 详细索引的双层策略</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core</span> <span style=color:#cf222e>import</span> SummaryIndex<span style=color:#1f2328>,</span> VectorStoreIndex
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#57606a># 创建摘要索引（用于快速过滤）</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>summary_index <span style=color:#0550ae>=</span> SummaryIndex<span style=color:#0550ae>.</span>from_documents<span style=color:#1f2328>(</span>documents<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#57606a># 创建详细索引（用于精确检索）</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>detailed_index <span style=color:#0550ae>=</span> VectorStoreIndex<span style=color:#0550ae>.</span>from_documents<span style=color:#1f2328>(</span>documents<span style=color:#1f2328>)</span>
</span></span></code></pre></div><h3 id=32-检索环节优化>3.2 检索环节优化<a hidden class=anchor aria-hidden=true href=#32-检索环节优化>#</a></h3><h4 id=321-查询重写详细实现>3.2.1 查询重写（详细实现）<a hidden class=anchor aria-hidden=true href=#321-查询重写详细实现>#</a></h4><p><strong>查询扩展（RAG-Fusion）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 多查询生成和融合检索</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.retrievers</span> <span style=color:#cf222e>import</span> MultiQueryRetriever
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#57606a># 生成多个相关查询</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>retriever <span style=color:#0550ae>=</span> MultiQueryRetriever<span style=color:#0550ae>.</span>from_defaults<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    retriever<span style=color:#0550ae>=</span>base_retriever<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    llm<span style=color:#0550ae>=</span>llm<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    num_queries<span style=color:#0550ae>=</span><span style=color:#0550ae>3</span>  <span style=color:#57606a># 生成3个相关查询</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#57606a># 使用倒数排序融合（RRF）</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.postprocessor</span> <span style=color:#cf222e>import</span> ReciprocalRerankFusion
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>reranker <span style=color:#0550ae>=</span> ReciprocalRerankFusion<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    top_k<span style=color:#0550ae>=</span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    fusion_weight<span style=color:#0550ae>=</span><span style=color:#0550ae>0.5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><p><strong>Step-Back Prompting</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># 后退一步提问策略</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>step_back_prompt <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#0a3069>请后退一步，思考这个问题的更广泛背景：</span><span style=color:#0a3069>{query}</span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#0a3069>基于这个背景，重新表述问题。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#0a3069>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#57606a># 使用LLM生成更抽象的问题</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>abstract_query <span style=color:#0550ae>=</span> llm<span style=color:#0550ae>.</span>generate<span style=color:#1f2328>(</span>step_back_prompt<span style=color:#0550ae>.</span>format<span style=color:#1f2328>(</span>query<span style=color:#0550ae>=</span>user_query<span style=color:#1f2328>))</span>
</span></span></code></pre></div><h4 id=322-多模态检索>3.2.2 多模态检索<a hidden class=anchor aria-hidden=true href=#322-多模态检索>#</a></h4><p><strong>混合检索实现</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 向量检索 + 关键词检索</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.retrievers</span> <span style=color:#cf222e>import</span> VectorIndexRetriever<span style=color:#1f2328>,</span> KeywordTableRetriever
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.retrievers</span> <span style=color:#cf222e>import</span> EnsembleRetriever
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>vector_retriever <span style=color:#0550ae>=</span> VectorIndexRetriever<span style=color:#1f2328>(</span>index<span style=color:#0550ae>=</span>vector_index<span style=color:#1f2328>,</span> similarity_top_k<span style=color:#0550ae>=</span><span style=color:#0550ae>5</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>keyword_retriever <span style=color:#0550ae>=</span> KeywordTableRetriever<span style=color:#1f2328>(</span>index<span style=color:#0550ae>=</span>keyword_index<span style=color:#1f2328>,</span> similarity_top_k<span style=color:#0550ae>=</span><span style=color:#0550ae>5</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>ensemble_retriever <span style=color:#0550ae>=</span> EnsembleRetriever<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    retrievers<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span>vector_retriever<span style=color:#1f2328>,</span> keyword_retriever<span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    weights<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span><span style=color:#0550ae>0.7</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.3</span><span style=color:#1f2328>]</span>  <span style=color:#57606a># 权重分配</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><p><strong>元数据过滤</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 基于时间、作者等元数据过滤</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.retrievers</span> <span style=color:#cf222e>import</span> VectorIndexRetriever
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>retriever <span style=color:#0550ae>=</span> VectorIndexRetriever<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    index<span style=color:#0550ae>=</span>vector_index<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    similarity_top_k<span style=color:#0550ae>=</span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    filters<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;date&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;&gt;=&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;2024-01-01&#34;</span><span style=color:#1f2328>}},</span>  <span style=color:#57606a># 2024年之后的文档</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;author&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;John Doe&#34;</span><span style=color:#1f2328>}</span>  <span style=color:#57606a># 特定作者的文档</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><h4 id=323-重排序技术>3.2.3 重排序技术<a hidden class=anchor aria-hidden=true href=#323-重排序技术>#</a></h4><p><strong>交叉编码器重排序</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 使用Cohere等服务的重排序</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.postprocessor.cohere_rerank</span> <span style=color:#cf222e>import</span> CohereRerank
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>cohere_rerank <span style=color:#0550ae>=</span> CohereRerank<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    api_key<span style=color:#0550ae>=</span>cohere_api_key<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    top_n<span style=color:#0550ae>=</span><span style=color:#0550ae>3</span>  <span style=color:#57606a># 返回最相关的3个结果</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>query_engine <span style=color:#0550ae>=</span> index<span style=color:#0550ae>.</span>as_query_engine<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    similarity_top_k<span style=color:#0550ae>=</span><span style=color:#0550ae>10</span><span style=color:#1f2328>,</span>  <span style=color:#57606a># 先检索10个</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    node_postprocessors<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span>cohere_rerank<span style=color:#1f2328>]</span>  <span style=color:#57606a># 然后重排序</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><p><strong>LongContextReorder</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># 解决&#34;中间信息丢失&#34;问题</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.postprocessor</span> <span style=color:#cf222e>import</span> LongContextReorder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>reorder <span style=color:#0550ae>=</span> LongContextReorder<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>query_engine <span style=color:#0550ae>=</span> index<span style=color:#0550ae>.</span>as_query_engine<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    similarity_top_k<span style=color:#0550ae>=</span><span style=color:#0550ae>5</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    node_postprocessors<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span>reorder<span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><h4 id=324-检索策略优化>3.2.4 检索策略优化<a hidden class=anchor aria-hidden=true href=#324-检索策略优化>#</a></h4><p><strong>多跳检索实现</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># 迭代式检索策略</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.query_engine</span> <span style=color:#cf222e>import</span> MultiStepQueryEngine
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>query_engine <span style=color:#0550ae>=</span> MultiStepQueryEngine<span style=color:#0550ae>.</span>from_defaults<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    query_engine_tools<span style=color:#0550ae>=</span><span style=color:#1f2328>[</span>tool1<span style=color:#1f2328>,</span> tool2<span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    max_iterations<span style=color:#0550ae>=</span><span style=color:#0550ae>3</span>  <span style=color:#57606a># 最多3次迭代</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><p><strong>动态检索（DRAGIN）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#57606a># 基于信息需求的动态检索</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.retrievers</span> <span style=color:#cf222e>import</span> DynamicRetriever
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>dynamic_retriever <span style=color:#0550ae>=</span> DynamicRetriever<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    base_retriever<span style=color:#0550ae>=</span>vector_retriever<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    llm<span style=color:#0550ae>=</span>llm<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    retrieval_threshold<span style=color:#0550ae>=</span><span style=color:#0550ae>0.7</span>  <span style=color:#57606a># 检索阈值</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><h3 id=33-生成环节优化>3.3 生成环节优化<a hidden class=anchor aria-hidden=true href=#33-生成环节优化>#</a></h3><h4 id=331-提示压缩技术>3.3.1 提示压缩技术<a hidden class=anchor aria-hidden=true href=#331-提示压缩技术>#</a></h4><p><strong>LongLLMLingua提示压缩</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 压缩过长的上下文</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.postprocessor</span> <span style=color:#cf222e>import</span> LongLLMLinguaPostprocessor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>node_postprocessor <span style=color:#0550ae>=</span> LongLLMLinguaPostprocessor<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    instruction_str<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;基于上下文回答问题&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    target_token<span style=color:#0550ae>=</span><span style=color:#0550ae>300</span><span style=color:#1f2328>,</span>  <span style=color:#57606a># 目标token数</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    rank_method<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;longllmlingua&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    additional_compress_kwargs<span style=color:#0550ae>=</span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#0a3069>&#34;condition_compare&#34;</span><span style=color:#1f2328>:</span> <span style=color:#cf222e>True</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#0a3069>&#34;context_budget&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;+100&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#0a3069>&#34;reorder_context&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;sort&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#57606a># 应用压缩</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>compressed_nodes <span style=color:#0550ae>=</span> node_postprocessor<span style=color:#0550ae>.</span>postprocess_nodes<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    retrieved_nodes<span style=color:#1f2328>,</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    query_bundle<span style=color:#0550ae>=</span>QueryBundle<span style=color:#1f2328>(</span>query_str<span style=color:#0550ae>=</span>query<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><h4 id=332-结构化输出>3.3.2 结构化输出<a hidden class=anchor aria-hidden=true href=#332-结构化输出>#</a></h4><p><strong>Pydantic程序</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 结构化输出解析</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.output_parsers</span> <span style=color:#cf222e>import</span> LangchainOutputParser
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.llms</span> <span style=color:#cf222e>import</span> OpenAI
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>langchain.output_parsers</span> <span style=color:#cf222e>import</span> StructuredOutputParser<span style=color:#1f2328>,</span> ResponseSchema
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#57606a># 定义输出模式</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>response_schemas <span style=color:#0550ae>=</span> <span style=color:#1f2328>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ResponseSchema<span style=color:#1f2328>(</span>name<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;answer&#34;</span><span style=color:#1f2328>,</span> description<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;问题的答案&#34;</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    ResponseSchema<span style=color:#1f2328>(</span>name<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;confidence&#34;</span><span style=color:#1f2328>,</span> description<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;答案的置信度&#34;</span><span style=color:#1f2328>),</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ResponseSchema<span style=color:#1f2328>(</span>name<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;sources&#34;</span><span style=color:#1f2328>,</span> description<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;引用来源&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#1f2328>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>lc_output_parser <span style=color:#0550ae>=</span> StructuredOutputParser<span style=color:#0550ae>.</span>from_response_schemas<span style=color:#1f2328>(</span>response_schemas<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>output_parser <span style=color:#0550ae>=</span> LangchainOutputParser<span style=color:#1f2328>(</span>lc_output_parser<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#57606a># 将解析器附加到LLM</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>llm <span style=color:#0550ae>=</span> OpenAI<span style=color:#1f2328>(</span>output_parser<span style=color:#0550ae>=</span>output_parser<span style=color:#1f2328>)</span>
</span></span></code></pre></div><h4 id=333-事实性增强>3.3.3 事实性增强<a hidden class=anchor aria-hidden=true href=#333-事实性增强>#</a></h4><p><strong>引用生成和验证</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#57606a># 自动生成引用</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>from</span> <span style=color:#24292e>llama_index.core.response_synthesizers</span> <span style=color:#cf222e>import</span> Refine
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>synthesizer <span style=color:#0550ae>=</span> Refine<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    llm<span style=color:#0550ae>=</span>llm<span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    response_mode<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;refine&#34;</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    include_ref<span style=color:#0550ae>=</span><span style=color:#cf222e>True</span>  <span style=color:#57606a># 包含引用</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#57606a># 置信度评估</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>confidence_prompt <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#0a3069>请评估以下回答的置信度（0-100分）：
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#0a3069>问题：</span><span style=color:#0a3069>{question}</span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#0a3069>回答：</span><span style=color:#0a3069>{answer}</span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#0a3069>上下文：</span><span style=color:#0a3069>{context}</span><span style=color:#0a3069>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#0a3069>&#34;&#34;&#34;</span>
</span></span></code></pre></div><h3 id=34-生成环节优化>3.4 生成环节优化<a hidden class=anchor aria-hidden=true href=#34-生成环节优化>#</a></h3><h4 id=341-生成控制>3.4.1 生成控制<a hidden class=anchor aria-hidden=true href=#341-生成控制>#</a></h4><ul><li><strong>温度调节</strong>：控制生成结果的随机性</li><li><strong>Top-p采样</strong>：控制生成词汇的多样性</li><li><strong>重复惩罚</strong>：避免重复内容生成</li></ul><h4 id=342-事实性增强>3.4.2 事实性增强<a hidden class=anchor aria-hidden=true href=#342-事实性增强>#</a></h4><ul><li><strong>引用生成</strong>：为生成内容添加引用来源</li><li><strong>置信度评估</strong>：评估生成内容的可信度</li><li><strong>事实核查</strong>：对生成内容进行事实验证</li></ul><h4 id=343-风格控制>3.4.3 风格控制<a hidden class=anchor aria-hidden=true href=#343-风格控制>#</a></h4><ul><li><strong>风格迁移</strong>：控制生成内容的风格</li><li><strong>长度控制</strong>：控制生成内容的长度</li><li><strong>格式控制</strong>：控制生成内容的格式</li></ul><h2 id=4-综合优化策略>4. 综合优化策略<a hidden class=anchor aria-hidden=true href=#4-综合优化策略>#</a></h2><h3 id=41-端到端优化>4.1 端到端优化<a hidden class=anchor aria-hidden=true href=#41-端到端优化>#</a></h3><ul><li><strong>联合训练</strong>：同时优化检索器和生成器</li><li><strong>强化学习</strong>：基于用户反馈优化系统</li><li><strong>多任务学习</strong>：同时优化多个相关任务</li></ul><h3 id=42-评估指标>4.2 评估指标<a hidden class=anchor aria-hidden=true href=#42-评估指标>#</a></h3><ul><li><strong>检索质量</strong>：Recall@k、NDCG、MRR</li><li><strong>生成质量</strong>：BLEU、ROUGE、BERTScore</li><li><strong>用户体验</strong>：响应时间、准确性、满意度</li></ul><h3 id=43-性能优化>4.3 性能优化<a hidden class=anchor aria-hidden=true href=#43-性能优化>#</a></h3><ul><li><strong>缓存策略</strong>：缓存频繁查询的结果</li><li><strong>异步处理</strong>：并行处理多个请求</li><li><strong>负载均衡</strong>：分布式部署提高并发能力</li></ul><h2 id=5-未来发展趋势>5. 未来发展趋势<a hidden class=anchor aria-hidden=true href=#5-未来发展趋势>#</a></h2><h3 id=51-技术趋势>5.1 技术趋势<a hidden class=anchor aria-hidden=true href=#51-技术趋势>#</a></h3><ul><li><strong>多模态RAG</strong>：结合文本、图像、音频等多模态信息</li><li><strong>自适应RAG</strong>：根据用户反馈自适应调整策略</li><li><strong>可解释RAG</strong>：提高系统的透明度和可解释性</li></ul><h3 id=52-应用趋势>5.2 应用趋势<a hidden class=anchor aria-hidden=true href=#52-应用趋势>#</a></h3><ul><li><strong>企业级应用</strong>：面向企业的定制化RAG解决方案</li><li><strong>移动端应用</strong>：轻量级RAG在移动设备上的应用</li><li><strong>边缘计算</strong>：在边缘设备上部署RAG系统</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://nky10.github.io/tags/rag/>RAG</a></li><li><a href=https://nky10.github.io/tags/%E5%85%AB%E8%82%A1%E6%96%87/>八股文</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://nky10.github.io/>openset的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>